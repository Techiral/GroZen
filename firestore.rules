
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Define your Admin UID here. Replace with your actual Admin UID if different.
    // Ensure 'QNSRsQsMqRRuS4288vtlBYT1a7E2' IS YOUR CORRECT ADMIN UID.
    function isAdmin() {
      return request.auth != null && request.auth.uid == 'QNSRsQsMqRRuS4288vtlBYT1a7E2';
    }

    // --- Usernames Collection ---
    match /usernames/{username} {
      allow get: if true;
      allow create: if request.auth != null &&
                       (request.resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // --- Rules for operations on individual documents within the 'users' collection ---
    match /users/{userIdFromPath} { // Renamed wildcard for clarity
      allow get: if request.auth != null && (request.auth.uid == userIdFromPath || isAdmin());
      allow create: if request.auth != null && (request.auth.uid == userIdFromPath || isAdmin());
      allow update: if request.auth != null && (request.auth.uid == userIdFromPath || isAdmin());
      allow delete: if isAdmin();

      // --- MoodLogs Subcollection (nested under each user) ---
      match /moodLogs/{logId} {
        allow read, write, delete: if request.auth != null && (request.auth.uid == userIdFromPath || isAdmin());
      }
    }

    // --- Rules for LIST operations on the 'users' collection itself ---
    // This allows authenticated users to perform queries like the leaderboard one.
    match /users { // No wildcard document ID here, applies to the collection path
        allow list: if request.auth != null;
        // Note: 'read' permission here would be 'list' + 'get'.
        // We want 'get' to be more specific (handled by /users/{userIdFromPath}),
        // so only 'list' is granted here broadly for authenticated users.
    }


    // --- Early Access Signups Collection ---
    match /earlyAccessSignups/{docId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }
  }
}
